<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="apelade : deep pale apelade ape lap leaped" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>apelade</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/apelade">View on GitHub</a>

          <h1 id="project_title">apelade</h1>
          <h2 id="project_tagline">deep pale apelade ape lap leaped</h2>

        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h3>Looking for these?</h3>
		<p><code>npm install --recursive</code>
		<code>npm update --recursive</code></p>
		<h3>No such animal!</h3>

<p>Today I watched the Holowaychuk video on vimeo about modular apps.
<a href="http://vimeo.com/56166857">http://vimeo.com/56166857</a>
He showed how he thought in the project main package.json that bundledDependencies should be able to have their deps recursively installed with npm install. It's still that way, which it is as of 4/16/2013, on node 0.10.4 and npm 1.2.18, win7-64</p>

<p>Looking in the npm issues, it's <a href="http://github.com/isaacs/npm/issues/2442">http://github.com/isaacs/npm/issues/2442</a>, and there was the non-recursive nature of install: <a href="https://github.com/isaacs/npm/issues/1341">https://github.com/isaacs/npm/issues/1341</a>
Before getting into the npm api, if ever, I wanted to do a sanity check that recursive install would not cause a probleme extraordinaire.</p>

<p>The script here could run update or install from a package.json hook. Good-guy npm survives calling install from a postinstall hook.</p>
<p>File package.json:
<pre><code>
{
  "name": "npm_recurse_demo",
  "version": "0.0.1",
  "description": "npm recurse demo",
  "dependencies": {
    "jade": "~0.28.2",
    "express": "~3.1.2"
  },
  "optionalDependencies": {"sax": "~0.5.2"},
  "scripts" : {
    "postinstall" : "node exec_util npm_install_rec /dev/npm_recurse_demo/lib/"
  }
}

</code></pre>
</p>

<p>File exec_util.js is too ugly. I'll be checking out CoffeScriptRedux and LiveScript. Here is the coffeescript:
<pre><code>
###
Execute arbitrary args in a dir, singly or recursively.
A list of ignore files prevents bad recursions.
A list of target files triggers exec of args if found in the cwd.
Usage: See npm_install_rec below.
DEF_IGNORES works for me, but do you ever need to go to node_modules?
Note: file is passed but not currently used in exec_args_in_dir.
Paul McCulloch, 16 April 2013
License: <= MIT
###

fs = require "fs"
DEF_IGNORES = ["node_modules", ".git"]

exec_args_in_dir = (args, dir) ->
  console.log "exec", args, "in", dir
  exec = require('child_process').exec
  command = exec args, {cwd:dir, stio:"inherit"}, (err,stout,sterr) ->
    console.log "\n cwd?", dir,
                "\n err?", err,
                "\n stout?", stout,
                "\n sterr?", sterr

func_walk = (args, file, parent=null, ignores=DEF_IGNORES, targets=[]) ->
  if args? and file?
    if file in targets and parent?
      exec_args_in_dir args, parent
    else if file not in ignores
      if parent?
        file = parent + "/" + file
      fs.stat file, (err,stats) ->
        console.log err if err?
        if stats.isDirectory()
          fs.readdir file, (err,files) ->
            if err?
              console.log err
            else
              for item in files
                do -> func_walk(args, item, file, ignores, targets)


npm_install_rec = (start) ->
  func_walk "npm -s install", start, null, DEF_IGNORES, ["package.json"]

npm_update_rec = (start) ->
  func_walk "npm -s update", start, null, DEF_IGNORES, ["package.json"]

module.exports = exports =
  func_walk: func_walk
  exec_args_in_dir: exec_args_in_dir
  npm_install_rec: npm_install_rec
  npm_update_rec: npm_update_rec

if process.argv?.length is 4
  module.exports[process.argv[2]](process.argv[3])
</code></pre>
</p>
<p>Here is the output of coffee-script-redux -j, not much better looking:
<pre><code>
// Generated by CoffeeScript 2.0.0-beta4
void function () {
  var DEF_IGNORES, exec_args_in_dir, exports, fs, func_walk, npm_install_rec, npm_update_rec;
  fs = require('fs');
  DEF_IGNORES = [
    'node_modules',
    '.git'
  ];
  exec_args_in_dir = function (args, dir) {
    var command, exec;
    console.log('exec', args, 'in', dir);
    exec = require('child_process').exec;
    return command = exec(args, {
      cwd: dir,
      stio: 'inherit'
    }, function (err, stout, sterr) {
      return console.log('\n cwd?', dir, '\n err?', err, '\n stout?', stout, '\n sterr?', sterr);
    });
  };
  func_walk = function (args, file, parent, ignores, targets) {
    if (null == parent)
      parent = null;
    if (null == ignores)
      ignores = DEF_IGNORES;
    if (null == targets)
      targets = [];
    if (null != args && null != file)
      if (in$(file, targets) && null != parent) {
        return exec_args_in_dir(args, parent);
      } else if (!in$(file, ignores)) {
        if (null != parent)
          file = parent + '/' + file;
        return fs.stat(file, function (err, stats) {
          if (null != err)
            console.log(err);
          if (stats.isDirectory())
            return fs.readdir(file, function (err, files) {
              if (null != err) {
                return console.log(err);
              } else {
                return function (accum$) {
                  var item;
                  for (var i$ = 0, length$ = files.length; i$ < length$; ++i$) {
                    item = files[i$];
                    accum$.push(function () {
                      return func_walk(args, item, file, ignores, targets);
                    }());
                  }
                  return accum$;
                }.call(this, []);
              }
            });
        });
      }
  };
  npm_install_rec = function (start) {
    return func_walk('npm -s install', start, null, DEF_IGNORES, ['package.json']);
  };
  npm_update_rec = function (start) {
    return func_walk('npm -s update', start, null, DEF_IGNORES, ['package.json']);
  };
  module.exports = exports = {
    func_walk: func_walk,
    exec_args_in_dir: exec_args_in_dir,
    npm_install_rec: npm_install_rec,
    npm_update_rec: npm_update_rec
  };
  if ((null != process.argv ? process.argv.length : void 0) === 4)
    module.exports[process.argv[2]](process.argv[3]);
  function in$(member, list) {
    for (var i = 0, length = list.length; i < length; ++i)
      if (i in list && list[i] === member)
        return true;
    return false;
  }
}.call(this);
</code></pre>
</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>



  </body>
</html>
